@page "/anagrafiche"
@inject AppStateService StateService

<PageTitle>Anagrafiche</PageTitle>

<h1>Anagrafiche</h1>

@if (!string.IsNullOrWhiteSpace(feedbackMessage))
{
    <p class="feedback">@feedbackMessage</p>
}

<section class="panel">
    <h2>Prodotti Grezzi</h2>
    <EditForm Model="prodottoForm" OnValidSubmit="SaveProdotto">
        <InputText @bind-Value="prodottoForm.Codice" placeholder="Codice prodotto" />
        <InputText @bind-Value="prodottoForm.Nome" placeholder="Nome prodotto" />
        <button type="submit">@(prodottoEditId is null ? "Aggiungi" : "Salva")</button>
        @if (prodottoEditId is not null)
        {
            <button type="button" @onclick="CancelProdottoEdit">Annulla</button>
        }
    </EditForm>

    <div class="toolbar">
        <InputText @bind-Value="prodottoFiltro" placeholder="Filtro prodotto" />
        <InputSelect @bind-Value="prodottoOrdinamento">
            <option value="codice-asc">Codice ↑</option>
            <option value="codice-desc">Codice ↓</option>
            <option value="nome-asc">Nome ↑</option>
            <option value="nome-desc">Nome ↓</option>
        </InputSelect>
    </div>

    <table>
        <thead><tr><th>Codice</th><th>Nome</th><th>Azioni</th></tr></thead>
        <tbody>
            @foreach (var prodotto in FilteredProdotti)
            {
                <tr>
                    <td>@prodotto.Codice</td>
                    <td>@prodotto.Nome</td>
                    <td class="actions-cell">
                        <button @onclick="() => EditProdotto(prodotto)">Modifica</button>
                        <button @onclick="() => DeleteProdotto(prodotto.Id)">Elimina</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</section>

<section class="panel">
    <h2>Varietà</h2>
    <EditForm Model="varietaForm" OnValidSubmit="SaveVarieta">
        <InputSelect @bind-Value="varietaForm.ProdottoId">
            <option value="">Seleziona prodotto</option>
            @foreach (var p in StateService.State.ProdottiGrezzi.OrderBy(x => x.Codice))
            {
                <option value="@p.Id">@p.Codice - @p.Nome</option>
            }
        </InputSelect>
        <InputText @bind-Value="varietaForm.Codice" placeholder="Codice varietà" />
        <InputText @bind-Value="varietaForm.Nome" placeholder="Nome varietà" />
        <button type="submit">@(varietaEditId is null ? "Aggiungi" : "Salva")</button>
        @if (varietaEditId is not null)
        {
            <button type="button" @onclick="CancelVarietaEdit">Annulla</button>
        }
    </EditForm>

    <div class="toolbar">
        <InputText @bind-Value="varietaFiltro" placeholder="Filtro varietà" />
        <InputSelect @bind-Value="varietaOrdinamento">
            <option value="codice-asc">Codice ↑</option>
            <option value="codice-desc">Codice ↓</option>
            <option value="nome-asc">Nome ↑</option>
            <option value="nome-desc">Nome ↓</option>
        </InputSelect>
    </div>

    <table>
        <thead><tr><th>Prodotto</th><th>Codice</th><th>Nome</th><th>Azioni</th></tr></thead>
        <tbody>
            @foreach (var varieta in FilteredVarieta)
            {
                <tr>
                    <td>@GetProdottoLabel(varieta.ProdottoId)</td>
                    <td>@varieta.Codice</td>
                    <td>@varieta.Nome</td>
                    <td class="actions-cell">
                        <button @onclick="() => EditVarieta(varieta)">Modifica</button>
                        <button @onclick="() => DeleteVarieta(varieta.Id)">Elimina</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</section>

<section class="panel">
    <h2>Imballaggi</h2>
    <EditForm Model="imballoForm" OnValidSubmit="SaveImballo">
        <InputText @bind-Value="imballoForm.Codice" placeholder="Codice imballo" />
        <InputText @bind-Value="imballoForm.Nome" placeholder="Nome imballo" />
        <InputNumber @bind-Value="imballoForm.TaraKg" placeholder="Tara kg (opzionale)" />
        <button type="submit">@(imballoEditId is null ? "Aggiungi" : "Salva")</button>
        @if (imballoEditId is not null)
        {
            <button type="button" @onclick="CancelImballoEdit">Annulla</button>
        }
    </EditForm>

    <div class="toolbar">
        <InputText @bind-Value="imballoFiltro" placeholder="Filtro imballaggio" />
        <InputSelect @bind-Value="imballoOrdinamento">
            <option value="codice-asc">Codice ↑</option>
            <option value="codice-desc">Codice ↓</option>
            <option value="nome-asc">Nome ↑</option>
            <option value="nome-desc">Nome ↓</option>
        </InputSelect>
    </div>

    <table>
        <thead><tr><th>Codice</th><th>Nome</th><th>Tara kg</th><th>Azioni</th></tr></thead>
        <tbody>
            @foreach (var imballo in FilteredImballi)
            {
                <tr>
                    <td>@imballo.Codice</td>
                    <td>@imballo.Nome</td>
                    <td>@(imballo.TaraKg?.ToString("0.###") ?? "-")</td>
                    <td class="actions-cell">
                        <button @onclick="() => EditImballo(imballo)">Modifica</button>
                        <button @onclick="() => DeleteImballo(imballo.Id)">Elimina</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</section>

<section class="panel">
    <h2>Articoli</h2>
    <EditForm Model="articoloForm" OnValidSubmit="SaveArticolo">
        <InputText @bind-Value="articoloForm.Codice" placeholder="Codice articolo" />
        <InputText @bind-Value="articoloForm.Nome" placeholder="Nome articolo" />
        <InputSelect @bind-Value="articoloForm.ProdottoId">
            <option value="">Nessun vincolo prodotto</option>
            @foreach (var p in StateService.State.ProdottiGrezzi.OrderBy(x => x.Codice))
            {
                <option value="@p.Id">@p.Codice - @p.Nome</option>
            }
        </InputSelect>
        <InputSelect @bind-Value="articoloForm.VarietaId">
            <option value="">Nessun vincolo varietà</option>
            @foreach (var v in VarietaDisponibiliPerArticolo())
            {
                <option value="@v.Id">@v.Codice - @v.Nome</option>
            }
        </InputSelect>
        <InputSelect @bind-Value="articoloForm.TipoPeso">
            <option value="EGALIZZATO">EGALIZZATO</option>
            <option value="USCENTE">USCENTE</option>
        </InputSelect>
        <InputNumber @bind-Value="articoloForm.PesoColloTeorico" placeholder="Peso collo teorico" />
        <button type="submit">@(articoloEditId is null ? "Aggiungi" : "Salva")</button>
        @if (articoloEditId is not null)
        {
            <button type="button" @onclick="CancelArticoloEdit">Annulla</button>
        }
    </EditForm>

    <div class="toolbar">
        <InputText @bind-Value="articoloFiltro" placeholder="Filtro articolo" />
        <InputSelect @bind-Value="articoloOrdinamento">
            <option value="codice-asc">Codice ↑</option>
            <option value="codice-desc">Codice ↓</option>
            <option value="nome-asc">Nome ↑</option>
            <option value="nome-desc">Nome ↓</option>
            <option value="peso-asc">Peso ↑</option>
            <option value="peso-desc">Peso ↓</option>
        </InputSelect>
    </div>

    <table>
        <thead><tr><th>Codice</th><th>Nome</th><th>Prodotto</th><th>Varietà</th><th>Tipo peso</th><th>Peso</th><th>Azioni</th></tr></thead>
        <tbody>
            @foreach (var articolo in FilteredArticoli)
            {
                <tr>
                    <td>@articolo.Codice</td>
                    <td>@articolo.Nome</td>
                    <td>@(articolo.ProdottoId is null ? "-" : GetProdottoLabel(articolo.ProdottoId))</td>
                    <td>@(articolo.VarietaId is null ? "-" : GetVarietaLabel(articolo.VarietaId))</td>
                    <td>@articolo.TipoPeso</td>
                    <td>@articolo.PesoColloTeorico.ToString("0.###")</td>
                    <td class="actions-cell">
                        <button @onclick="() => EditArticolo(articolo)">Modifica</button>
                        <button @onclick="() => DeleteArticolo(articolo.Id)">Elimina</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</section>

@code {
    private string? feedbackMessage;

    private ProdottoForm prodottoForm = new();
    private string? prodottoEditId;
    private string prodottoFiltro = string.Empty;
    private string prodottoOrdinamento = "codice-asc";

    private VarietaForm varietaForm = new();
    private string? varietaEditId;
    private string varietaFiltro = string.Empty;
    private string varietaOrdinamento = "codice-asc";

    private ImballoForm imballoForm = new();
    private string? imballoEditId;
    private string imballoFiltro = string.Empty;
    private string imballoOrdinamento = "codice-asc";

    private ArticoloForm articoloForm = new() { TipoPeso = "EGALIZZATO" };
    private string? articoloEditId;
    private string articoloFiltro = string.Empty;
    private string articoloOrdinamento = "codice-asc";

    private IEnumerable<ProdottoGrezzo> FilteredProdotti =>
        ApplyOrdering(
            StateService.State.ProdottiGrezzi.Where(p => ContainsText($"{p.Codice} {p.Nome}", prodottoFiltro)),
            prodottoOrdinamento,
            x => x.Codice,
            x => x.Nome);

    private IEnumerable<Varieta> FilteredVarieta =>
        ApplyOrdering(
            StateService.State.Varieta.Where(v => ContainsText($"{GetProdottoLabel(v.ProdottoId)} {v.Codice} {v.Nome}", varietaFiltro)),
            varietaOrdinamento,
            x => x.Codice,
            x => x.Nome);

    private IEnumerable<Imballo> FilteredImballi =>
        ApplyOrdering(
            StateService.State.Imballi.Where(i => ContainsText($"{i.Codice} {i.Nome}", imballoFiltro)),
            imballoOrdinamento,
            x => x.Codice,
            x => x.Nome);

    private IEnumerable<Articolo> FilteredArticoli =>
        ApplyOrderingWithPeso(
            StateService.State.Articoli.Where(a => ContainsText($"{a.Codice} {a.Nome} {GetProdottoLabel(a.ProdottoId)} {GetVarietaLabel(a.VarietaId)}", articoloFiltro)),
            articoloOrdinamento);

    private void SaveProdotto()
    {
        var codice = prodottoForm.Codice.Trim().ToUpperInvariant();
        var nome = prodottoForm.Nome.Trim();

        if (string.IsNullOrWhiteSpace(codice) || string.IsNullOrWhiteSpace(nome))
        {
            feedbackMessage = "Prodotto non valido: codice e nome sono obbligatori.";
            return;
        }

        var duplicate = StateService.State.ProdottiGrezzi.Any(p =>
            p.Codice.Equals(codice, StringComparison.OrdinalIgnoreCase)
            && p.Id != prodottoEditId);

        if (duplicate)
        {
            feedbackMessage = $"Codice prodotto '{codice}' già in uso.";
            return;
        }

        if (prodottoEditId is null)
        {
            StateService.State.ProdottiGrezzi.Add(new ProdottoGrezzo
            {
                Id = Guid.NewGuid().ToString("N"),
                Codice = codice,
                Nome = nome,
                Attivo = true,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            });
            feedbackMessage = "Prodotto aggiunto.";
        }
        else
        {
            var prodotto = StateService.State.ProdottiGrezzi.FirstOrDefault(p => p.Id == prodottoEditId);
            if (prodotto is null)
            {
                feedbackMessage = "Prodotto non trovato.";
                return;
            }

            prodotto.Codice = codice;
            prodotto.Nome = nome;
            prodotto.UpdatedAt = DateTime.UtcNow;
            feedbackMessage = "Prodotto aggiornato.";
        }

        StateService.Save();
        CancelProdottoEdit();
    }

    private void EditProdotto(ProdottoGrezzo prodotto)
    {
        prodottoEditId = prodotto.Id;
        prodottoForm = new ProdottoForm { Codice = prodotto.Codice, Nome = prodotto.Nome };
        feedbackMessage = null;
    }

    private void DeleteProdotto(string id)
    {
        if (StateService.State.Varieta.Any(v => v.ProdottoId == id) || StateService.State.Articoli.Any(a => a.ProdottoId == id))
        {
            feedbackMessage = "Impossibile eliminare: prodotto referenziato da varietà o articoli.";
            return;
        }

        var removed = StateService.State.ProdottiGrezzi.Remove(StateService.State.ProdottiGrezzi.First(p => p.Id == id));
        if (removed)
        {
            StateService.Save();
            feedbackMessage = "Prodotto eliminato.";
        }
    }

    private void CancelProdottoEdit()
    {
        prodottoEditId = null;
        prodottoForm = new ProdottoForm();
    }

    private void SaveVarieta()
    {
        if (string.IsNullOrWhiteSpace(varietaForm.ProdottoId))
        {
            feedbackMessage = "Varietà non valida: selezionare un prodotto.";
            return;
        }

        var codice = varietaForm.Codice.Trim().ToUpperInvariant();
        var nome = varietaForm.Nome.Trim();
        if (string.IsNullOrWhiteSpace(codice) || string.IsNullOrWhiteSpace(nome))
        {
            feedbackMessage = "Varietà non valida: codice e nome sono obbligatori.";
            return;
        }

        var duplicate = StateService.State.Varieta.Any(v =>
            v.ProdottoId == varietaForm.ProdottoId
            && v.Codice.Equals(codice, StringComparison.OrdinalIgnoreCase)
            && v.Id != varietaEditId);

        if (duplicate)
        {
            feedbackMessage = $"Codice varietà '{codice}' già in uso per il prodotto selezionato.";
            return;
        }

        if (varietaEditId is null)
        {
            StateService.State.Varieta.Add(new Varieta
            {
                Id = Guid.NewGuid().ToString("N"),
                ProdottoId = varietaForm.ProdottoId,
                Codice = codice,
                Nome = nome,
                Attiva = true,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            });
            feedbackMessage = "Varietà aggiunta.";
        }
        else
        {
            var varieta = StateService.State.Varieta.FirstOrDefault(v => v.Id == varietaEditId);
            if (varieta is null)
            {
                feedbackMessage = "Varietà non trovata.";
                return;
            }

            varieta.ProdottoId = varietaForm.ProdottoId;
            varieta.Codice = codice;
            varieta.Nome = nome;
            varieta.UpdatedAt = DateTime.UtcNow;
            feedbackMessage = "Varietà aggiornata.";
        }

        StateService.Save();
        CancelVarietaEdit();
    }

    private void EditVarieta(Varieta varieta)
    {
        varietaEditId = varieta.Id;
        varietaForm = new VarietaForm
        {
            ProdottoId = varieta.ProdottoId,
            Codice = varieta.Codice,
            Nome = varieta.Nome
        };
        feedbackMessage = null;
    }

    private void DeleteVarieta(string id)
    {
        if (StateService.State.Articoli.Any(a => a.VarietaId == id))
        {
            feedbackMessage = "Impossibile eliminare: varietà referenziata da articoli.";
            return;
        }

        var item = StateService.State.Varieta.FirstOrDefault(v => v.Id == id);
        if (item is null)
        {
            return;
        }

        StateService.State.Varieta.Remove(item);
        StateService.Save();
        feedbackMessage = "Varietà eliminata.";
    }

    private void CancelVarietaEdit()
    {
        varietaEditId = null;
        varietaForm = new VarietaForm();
    }

    private void SaveImballo()
    {
        var codice = imballoForm.Codice.Trim().ToUpperInvariant();
        var nome = imballoForm.Nome.Trim();

        if (string.IsNullOrWhiteSpace(codice) || string.IsNullOrWhiteSpace(nome))
        {
            feedbackMessage = "Imballaggio non valido: codice e nome sono obbligatori.";
            return;
        }

        var duplicate = StateService.State.Imballi.Any(i =>
            i.Codice.Equals(codice, StringComparison.OrdinalIgnoreCase)
            && i.Id != imballoEditId);

        if (duplicate)
        {
            feedbackMessage = $"Codice imballaggio '{codice}' già in uso.";
            return;
        }

        if (imballoEditId is null)
        {
            StateService.State.Imballi.Add(new Imballo
            {
                Id = Guid.NewGuid().ToString("N"),
                Codice = codice,
                Nome = nome,
                TaraKg = imballoForm.TaraKg,
                Attivo = true,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            });
            feedbackMessage = "Imballaggio aggiunto.";
        }
        else
        {
            var imballo = StateService.State.Imballi.FirstOrDefault(i => i.Id == imballoEditId);
            if (imballo is null)
            {
                feedbackMessage = "Imballaggio non trovato.";
                return;
            }

            imballo.Codice = codice;
            imballo.Nome = nome;
            imballo.TaraKg = imballoForm.TaraKg;
            imballo.UpdatedAt = DateTime.UtcNow;
            feedbackMessage = "Imballaggio aggiornato.";
        }

        StateService.Save();
        CancelImballoEdit();
    }

    private void EditImballo(Imballo imballo)
    {
        imballoEditId = imballo.Id;
        imballoForm = new ImballoForm { Codice = imballo.Codice, Nome = imballo.Nome, TaraKg = imballo.TaraKg };
        feedbackMessage = null;
    }

    private void DeleteImballo(string id)
    {
        if (StateService.State.Lavorazioni.Any(l => l.ImballoId == id))
        {
            feedbackMessage = "Impossibile eliminare: imballaggio usato in lavorazioni.";
            return;
        }

        var item = StateService.State.Imballi.FirstOrDefault(i => i.Id == id);
        if (item is null)
        {
            return;
        }

        StateService.State.Imballi.Remove(item);
        StateService.Save();
        feedbackMessage = "Imballaggio eliminato.";
    }

    private void CancelImballoEdit()
    {
        imballoEditId = null;
        imballoForm = new ImballoForm();
    }

    private void SaveArticolo()
    {
        var codice = articoloForm.Codice.Trim().ToUpperInvariant();
        var nome = articoloForm.Nome.Trim();

        if (string.IsNullOrWhiteSpace(codice) || string.IsNullOrWhiteSpace(nome) || articoloForm.PesoColloTeorico <= 0)
        {
            feedbackMessage = "Articolo non valido: codice, nome e peso > 0 sono obbligatori.";
            return;
        }

        var duplicate = StateService.State.Articoli.Any(a =>
            a.Codice.Equals(codice, StringComparison.OrdinalIgnoreCase)
            && a.Id != articoloEditId);

        if (duplicate)
        {
            feedbackMessage = $"Codice articolo '{codice}' già in uso.";
            return;
        }

        if (!string.IsNullOrWhiteSpace(articoloForm.VarietaId) && string.IsNullOrWhiteSpace(articoloForm.ProdottoId))
        {
            feedbackMessage = "Se selezioni una varietà devi selezionare anche il prodotto.";
            return;
        }

        if (!string.IsNullOrWhiteSpace(articoloForm.VarietaId))
        {
            var varieta = StateService.State.Varieta.FirstOrDefault(v => v.Id == articoloForm.VarietaId);
            if (varieta is null || varieta.ProdottoId != articoloForm.ProdottoId)
            {
                feedbackMessage = "Varietà non coerente con prodotto selezionato.";
                return;
            }
        }

        if (articoloEditId is null)
        {
            StateService.State.Articoli.Add(new Articolo
            {
                Id = Guid.NewGuid().ToString("N"),
                Codice = codice,
                Nome = nome,
                ProdottoId = NullIfEmpty(articoloForm.ProdottoId),
                VarietaId = NullIfEmpty(articoloForm.VarietaId),
                TipoPeso = articoloForm.TipoPeso,
                PesoColloTeorico = articoloForm.PesoColloTeorico,
                Attivo = true,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            });
            feedbackMessage = "Articolo aggiunto.";
        }
        else
        {
            var articolo = StateService.State.Articoli.FirstOrDefault(a => a.Id == articoloEditId);
            if (articolo is null)
            {
                feedbackMessage = "Articolo non trovato.";
                return;
            }

            articolo.Codice = codice;
            articolo.Nome = nome;
            articolo.ProdottoId = NullIfEmpty(articoloForm.ProdottoId);
            articolo.VarietaId = NullIfEmpty(articoloForm.VarietaId);
            articolo.TipoPeso = articoloForm.TipoPeso;
            articolo.PesoColloTeorico = articoloForm.PesoColloTeorico;
            articolo.UpdatedAt = DateTime.UtcNow;
            feedbackMessage = "Articolo aggiornato.";
        }

        StateService.Save();
        CancelArticoloEdit();
    }

    private void EditArticolo(Articolo articolo)
    {
        articoloEditId = articolo.Id;
        articoloForm = new ArticoloForm
        {
            Codice = articolo.Codice,
            Nome = articolo.Nome,
            ProdottoId = articolo.ProdottoId ?? string.Empty,
            VarietaId = articolo.VarietaId ?? string.Empty,
            TipoPeso = articolo.TipoPeso,
            PesoColloTeorico = articolo.PesoColloTeorico
        };
        feedbackMessage = null;
    }

    private void DeleteArticolo(string id)
    {
        if (StateService.State.Lavorazioni.Any(l => l.ArticoloId == id))
        {
            feedbackMessage = "Impossibile eliminare: articolo usato in lavorazioni.";
            return;
        }

        var item = StateService.State.Articoli.FirstOrDefault(a => a.Id == id);
        if (item is null)
        {
            return;
        }

        StateService.State.Articoli.Remove(item);
        StateService.Save();
        feedbackMessage = "Articolo eliminato.";
    }

    private void CancelArticoloEdit()
    {
        articoloEditId = null;
        articoloForm = new ArticoloForm { TipoPeso = "EGALIZZATO" };
    }

    private IEnumerable<Varieta> VarietaDisponibiliPerArticolo()
    {
        var query = StateService.State.Varieta.AsEnumerable();
        if (!string.IsNullOrWhiteSpace(articoloForm.ProdottoId))
        {
            query = query.Where(v => v.ProdottoId == articoloForm.ProdottoId);
        }

        return query.OrderBy(v => v.Codice).ThenBy(v => v.Nome);
    }

    private string GetProdottoLabel(string? prodottoId)
    {
        if (string.IsNullOrWhiteSpace(prodottoId))
        {
            return "-";
        }

        var prodotto = StateService.State.ProdottiGrezzi.FirstOrDefault(p => p.Id == prodottoId);
        return prodotto is null ? "-" : $"{prodotto.Codice} - {prodotto.Nome}";
    }

    private string GetVarietaLabel(string? varietaId)
    {
        if (string.IsNullOrWhiteSpace(varietaId))
        {
            return "-";
        }

        var varieta = StateService.State.Varieta.FirstOrDefault(v => v.Id == varietaId);
        return varieta is null ? "-" : $"{varieta.Codice} - {varieta.Nome}";
    }

    private static bool ContainsText(string value, string filter)
        => string.IsNullOrWhiteSpace(filter)
           || value.Contains(filter.Trim(), StringComparison.OrdinalIgnoreCase);

    private static IEnumerable<T> ApplyOrdering<T>(IEnumerable<T> source, string order, Func<T, string> byCode, Func<T, string> byName)
        => order switch
        {
            "codice-desc" => source.OrderByDescending(byCode).ThenBy(byName),
            "nome-asc" => source.OrderBy(byName).ThenBy(byCode),
            "nome-desc" => source.OrderByDescending(byName).ThenBy(byCode),
            _ => source.OrderBy(byCode).ThenBy(byName)
        };

    private static IEnumerable<Articolo> ApplyOrderingWithPeso(IEnumerable<Articolo> source, string order)
        => order switch
        {
            "codice-desc" => source.OrderByDescending(x => x.Codice).ThenBy(x => x.Nome),
            "nome-asc" => source.OrderBy(x => x.Nome).ThenBy(x => x.Codice),
            "nome-desc" => source.OrderByDescending(x => x.Nome).ThenBy(x => x.Codice),
            "peso-asc" => source.OrderBy(x => x.PesoColloTeorico).ThenBy(x => x.Codice),
            "peso-desc" => source.OrderByDescending(x => x.PesoColloTeorico).ThenBy(x => x.Codice),
            _ => source.OrderBy(x => x.Codice).ThenBy(x => x.Nome)
        };

    private static string? NullIfEmpty(string? value)
        => string.IsNullOrWhiteSpace(value) ? null : value;

    private sealed class ProdottoForm
    {
        public string Codice { get; set; } = string.Empty;
        public string Nome { get; set; } = string.Empty;
    }

    private sealed class VarietaForm
    {
        public string ProdottoId { get; set; } = string.Empty;
        public string Codice { get; set; } = string.Empty;
        public string Nome { get; set; } = string.Empty;
    }

    private sealed class ImballoForm
    {
        public string Codice { get; set; } = string.Empty;
        public string Nome { get; set; } = string.Empty;
        public decimal? TaraKg { get; set; }
    }

    private sealed class ArticoloForm
    {
        public string Codice { get; set; } = string.Empty;
        public string Nome { get; set; } = string.Empty;
        public string ProdottoId { get; set; } = string.Empty;
        public string VarietaId { get; set; } = string.Empty;
        public string TipoPeso { get; set; } = "EGALIZZATO";
        public decimal PesoColloTeorico { get; set; }
    }
}
